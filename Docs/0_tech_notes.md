## Компоненты

##### Redis - хранение jwt 

1. Таблица всех актуальных токенов для рефреша токена доступа
2. Таблица токенов не истекших еще по времени, но недействительных для аксеса, так как был локаута юзера
3. Настройка бэкапов RDB, AOF

##### Postgress - основная БД

1.  Таблица user (id, login, password, is_superuser, is_active, date_joined, first_name, last_name)
2.  Таблица role (id, role_name, role_description)
3.  Таблица user_role (id, user_id, role_id)
4.  Таблица access_history (id, user_id, user_agent, login_date, login_status)

##### Flask server приложения реализующего 2 группы API

1. Регистрации, аутентификации, авторизации, и выпуска токенов
	- регистрация пользователя;
	- вход пользователя в аккаунт (обмен логина и пароля на пару токенов: JWT-access токен и refresh токен
	- обновление access-токена;
	- выход пользователя из аккаунта;
	- изменение логина или пароля 
	- получение пользователем своей истории входов в аккаун
	
2.  Создания и управления ролями
	- CRUD для управления ролями:
		- создание роли
		- удаление роли,
		- изменение роли,
		- просмотр всех ролей.
	- назначить пользователю роль; после этого рефрешить токены юзеру и добавлять туда группу
	- отобрать у пользователя роль; после этого рефрешить токены юзеру и добавлять туда группу
	- метод для проверки наличия прав у пользователя (вытаскивать из токена group_id)
	
##### Nginx

## Изменения в предыдущих сервисах
Так как будет использоваться Role based система для определения доступных фильмов необходимо:
	- в фильмы в postgress добавить поле указание какой роли оно доступно. Many2Many relations. Отдельная таблица подписок нужна. Как-то ее синхрить отсюда
	- в ETL добавить это поле (массив индексов - подписок в которых доступен фильм)
	- в ES в индекс добавить это поле
  

## Библиотеки

- Flask
- SqlAlchemy
- redis-py
- flask-marshmallow
- flasgger
- flask-security
- flask-jwt-extended


## Проработать
- Шифрование
	- сделать после авторизации генерацию session key
	- сделать обмен персональными данными только в шифрованном виде
	- в БД складывать персоноальные данные в шифрованном виде:
		- при этом использовать симметричное шифрование, ключ генерировать в два этапа на основе пароля пользователя
- Продумайте, как реализовать работу с анонимными пользователями: они могут выполнять только те действия, для которых не нужны особые права.
- Добавьте консольную команду для создания суперпользователя, которому всегда разрешено делать все действия в системе.
- Чтобы упростить себе жизнь с настройкой суперпользователя, продумайте, как сделать так, чтобы при авторизации ему всегда отдавался успех при всех запросах.

## Вопросы
1. Кто может создавать и удалять роли? только супер пользователь?
2. Роли нужны только для ограничения доступа к фильмам?
3. Кто будет добавлять роли юзерам - сам юзер (после валидации оплаты) или супер пользователь?


## Формат токена
```
access token payload
{
	"user_id": "",
	"group_id": [1,2,3],
	"ciphering_key": key3 # see 1_registration,
	"exp_time": ""
}

refresh token payload
{
	"user_id": "",
	"exp_time": ""
}
```
